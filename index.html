<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PTSC / THRI Crew Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
/* Login Overlay */
#login-overlay {
  position: fixed;
  top:0; left:0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.login-box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  width: 300px;
}
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <div class="login-box">
    <h4 class="mb-3">PTSC/THRI Login</h4>
    <input type="text" id="login-username" class="form-control mb-2" placeholder="Username">
    <input type="password" id="login-password" class="form-control mb-2" placeholder="Password">
    <button type="button" class="btn btn-primary w-100" onclick="loginUser()">Login</button>
    <div id="login-error" style="color:red;margin-top:10px;"></div>
  </div>
</div>

<!-- DASHBOARD SUMMARY -->
<div class="container mt-4">
  <div class="row">
    <div class="col"><h5>Vessel Join: <span id="dash-vesseljoin"></span></h5></div>
    <div class="col"><h5>Arrivals: <span id="dash-arrivals"></span></h5></div>
    <div class="col"><h5>Updates: <span id="dash-updates"></span></h5></div>
    <div class="col"><h5>Memo: <span id="dash-memo"></span></h5></div>
    <div class="col"><h5>Training: <span id="dash-training"></span></h5></div>
    <div class="col"><h5>P&I: <span id="dash-pni"></span></h5></div>
  </div>
</div>

<!-- TABLE CONTAINERS -->
<div class="container mt-4">
  <h5>Vessel Join</h5>
  <div id="crew-join-data"></div>
  
  <h5>Arrivals</h5>
  <div id="crew-arrivals-data"></div>

  <h5>Updates</h5>
  <div id="daily-updates-data"></div>

  <h5>Memo</h5>
  <div id="memo-data"></div>

  <h5>Training</h5>
  <div id="training-data"></div>

  <h5>P&I</h5>
  <div id="pni-data"></div>

  <h5>Chatboard</h5>
  <div id="chatboard"></div>
  <input type="text" id="chat-input" class="form-control my-2" placeholder="Type a message">
  <button class="btn btn-primary mb-4" onclick="sendMessage()">Send</button>
</div>

<!-- APP.JS -->
<script src="app.js"></script>

<!-- PDF GENERATOR -->
<script>
function getJsPdf() {
  if (window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
  if (window.jsPDF) return window.jsPDF;
  return null;
}

function getMonthYear(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString('en-US', { month: 'long', year: 'numeric' });
}

async function generateMonthlyGroupedPDF(type = "Join") {
  const sheetMap = { "Join": "Vessel_Join", "Arrival": "Arrivals" };
  const sheetName = sheetMap[type];
  if (!sheetName) { alert("Unknown PDF type: " + type); return; }

  const live = await apiFetch(sheetName, "get").catch(()=>[]);
  const archived = await apiFetch(`Archive_${sheetName}`, "get").catch(()=>[]);
  const all = [...(live||[]), ...(archived||[])];

  if (!all.length) { 
    alert("No records to export for " + sheetName); 
    return; 
  }

  const jsPDFCtor = getJsPdf();
  if (!jsPDFCtor) { alert("jsPDF not loaded"); return; }
  const doc = new jsPDFCtor('p','pt','a4');

  doc.setFontSize(14);
  doc.text(`PTSC / THRI â€” ${type} Crew Report`, 40, 40);

  const monthGroups = {};
  all.forEach(r => {
    const month = getMonthYear(r["Date"]);
    if (!monthGroups[month]) monthGroups[month] = [];
    monthGroups[month].push(r);
  });

  let currentY = 60;
  const headers = Object.keys(all[0]);

  if (doc.autoTable) {
    for (const [month, rows] of Object.entries(monthGroups)) {
      doc.setFontSize(12);
      doc.text(month, 40, currentY);
      currentY += 10;

      doc.autoTable({
        startY: currentY,
        head: [headers],
        body: rows.map(r => headers.map(h => r[h]||"")),
        styles: { fontSize: 8, cellPadding: 3 },
        headStyles: { fillColor: [0,57,107], textColor: 255 }
      });

      currentY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : currentY + 100;
    }
  }

  const safeTitle = `PTSC_THRI_${type}_Crew_All_Months.pdf`;
  doc.save(safeTitle);
}
</script>

</body>
</html>
